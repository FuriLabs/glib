--- a/glib/gkeyfile.c	2008-03-11 01:31:57.000000000 +0100
+++ b/glib/gkeyfile.c	2008-03-20 16:49:25.000000000 +0100
@@ -21,6 +21,10 @@
  *   Boston, MA 02111-1307, USA.
  */
 
+#define X_DEBIAN_GETTEXT_DOMAIN    "X-Debian-Gettext-Domain"
+#define X_UBUNTU_GETTEXT_DOMAIN    "X-Ubuntu-Gettext-Domain"
+#define X_DESKTOP_ENTRY     "Desktop Entry"
+
 #include "config.h"
 
 #include "gkeyfile.h"
@@ -83,6 +87,7 @@
   GKeyFileFlags flags;
 
   gchar **locales;
+  char          *gettext_domain;
 };
 
 typedef struct _GKeyFileKeyValuePair GKeyFileKeyValuePair;
@@ -209,6 +214,7 @@
   key_file->list_separator = ';';
   key_file->flags = 0;
   key_file->locales = g_strdupv ((gchar **)g_get_language_names ());
+  key_file->gettext_domain = NULL;
 }
 
 static void
@@ -227,6 +233,7 @@
       g_string_free (key_file->parse_buffer, TRUE);
       key_file->parse_buffer = NULL;
     }
+  g_free(key_file->gettext_domain);
 
   tmp = key_file->groups;
   while (tmp != NULL)
@@ -448,6 +455,10 @@
       return FALSE;
     }
 
+  key_file->gettext_domain = g_key_file_get_string (key_file, X_DESKTOP_ENTRY, X_UBUNTU_GETTEXT_DOMAIN, NULL);
+  if (!key_file->gettext_domain)
+      key_file->gettext_domain = g_key_file_get_string (key_file, X_DESKTOP_ENTRY, X_DEBIAN_GETTEXT_DOMAIN, NULL);
+
   return TRUE;
 }
 
@@ -553,6 +564,10 @@
       g_propagate_error (error, key_file_error);
       return FALSE;
     }
+  
+  key_file->gettext_domain = g_key_file_get_string (key_file, X_DESKTOP_ENTRY, X_UBUNTU_GETTEXT_DOMAIN, NULL);
+  if (!key_file->gettext_domain)
+      key_file->gettext_domain = g_key_file_get_string (key_file, X_DESKTOP_ENTRY, X_DEBIAN_GETTEXT_DOMAIN, NULL);
 
   return TRUE;
 }
@@ -1679,6 +1694,32 @@
       languages = (gchar **) g_get_language_names ();
       free_languages = FALSE;
     }
+
+  if (key_file->gettext_domain) 
+    {
+      char *orig_value = g_key_file_get_string (key_file, group_name, key, NULL);
+      if (orig_value)
+        {
+	  gboolean has_gettext;
+
+	  /* fprintf (stderr, "Resolved:   '%s'='%s'\n", key, orig_value); */
+	  translated_value = dgettext (key_file->gettext_domain, orig_value);
+	  has_gettext = translated_value != orig_value;
+	  g_free (orig_value);
+
+	  if (has_gettext)
+	    { 
+	      if (bind_textdomain_codeset (key_file->gettext_domain, NULL))
+		  translated_value = g_strdup (translated_value);
+	      else
+		  translated_value = g_locale_to_utf8 (translated_value, -1, NULL, NULL, NULL);
+	      /* fprintf (stderr, "Translated: '%s' -(via %s)- '%s'\n", orig_value, key_file->gettext_domain, translated_value); */
+	      goto done;
+	    } 
+	  else 
+	      translated_value = NULL;
+	}
+    }
   
   for (i = 0; languages[i]; i++)
     {
@@ -1707,6 +1748,8 @@
         g_propagate_error (error, key_file_error);
     }
 
+done:
+
   if (free_languages)
     g_strfreev (languages);
 
