From: Simon McVittie <smcv@debian.org>
Date: Fri, 8 Mar 2024 10:16:18 +0000
Subject: tests: Skip some tests without desktop-file-utils, shared-mime-info

For bootstrapping with a partial version of nocheck.

Forwarded: not-needed
---
 gio/tests/meson.build | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/gio/tests/meson.build b/gio/tests/meson.build
index 4ef3343..fb82c7f 100644
--- a/gio/tests/meson.build
+++ b/gio/tests/meson.build
@@ -62,6 +62,7 @@ gio_tests = {
   'contenttype' : {
     # FIXME: https://gitlab.gnome.org/GNOME/glib/-/issues/1392 / https://gitlab.gnome.org/GNOME/glib/-/issues/1251
     'can_fail' : host_system == 'darwin',
+    'needs_external_program': 'update-mime-database',
   },
   'converter-stream' : {},
   'credentials' : {},
@@ -232,7 +233,9 @@ endif
 #  Test programs buildable on UNIX only
 if host_machine.system() != 'windows'
   gio_tests += {
-    'file' : {},
+    'file' : {
+        'needs_external_program': 'update-desktop-database',
+    },
     'gdbus-peer-object-manager' : {},
     'gdbus-sasl' : {},
     'live-g-file' : {},
@@ -319,11 +322,13 @@ if host_machine.system() != 'windows'
       'appinfo' : {
         'install' : false,
         'extra_programs' : ['appinfo-test'],
+        'needs_external_program': 'update-desktop-database',
       },
       'desktop-app-info' : {
         'install' : false,
         'depends' : gio_launch_desktop,
         'extra_programs' : ['apps', 'appinfo-test'],
+        'needs_external_program': 'update-desktop-database',
       },
     }
   endif
@@ -994,6 +999,12 @@ foreach test_name, extra_args : gio_tests
   install = installed_tests_enabled and extra_args.get('install', true)
   installed_tests_env = extra_args.get('installed_tests_env', {})
 
+  needs_external_program = extra_args.get('needs_external_program', '')
+
+  if needs_external_program != '' and not find_program(needs_external_program, required: false).found()
+    continue
+  endif
+
   if install
     test_conf = configuration_data()
     test_conf.set('installed_tests_dir', installed_tests_execdir)
