--- a/configure.ac
+++ b/configure.ac
@@ -995,6 +995,9 @@
 AC_CHECK_FUNCS(getmntent_r setmntent endmntent hasmntopt getfsstat getvfsstat fallocate)
 # Check for high-resolution sleep functions
 AC_CHECK_FUNCS(splice)
+AC_CHECK_DECLS([prlimit], [], [], [[
+#include <sys/time.h>
+#include <sys/resource.h>]])
 AC_CHECK_FUNCS(prlimit)
 
 # To avoid finding a compatibility unusable statfs, which typically
Index: b/glib/tests/thread.c
===================================================================
--- a/glib/tests/thread.c
+++ b/glib/tests/thread.c
@@ -130,7 +130,7 @@
 static void
 test_thread4 (void)
 {
-#ifdef HAVE_PRLIMIT
+#if HAVE_DECL_PRLIMIT && defined(HAVE_PRLIMIT)
   struct rlimit ol, nl;
   GThread *thread;
   GError *error;
